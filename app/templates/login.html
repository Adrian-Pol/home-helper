{% extends "base.html" %}

{% block title %}Logowanie{% endblock %}

{% block content %}
<h1>Zaloguj się</h1>
{% if error %}
    <div class="error" id="error-server">{{ error }}</div>
{% endif %}

<form id="loginForm" method="post" action="/login">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

    <input type="text" id="username" name="username" placeholder="Nazwa użytkownika" required>
    <input type="password" id="password" name="password" placeholder="Hasło" required>
    <button id="submitBtn" type="submit">Zaloguj</button>
</form>

<div id="error" role="alert" style="color: red; margin-top: 0.5em;"></div>

<p style="text-align:center; margin-top: 10px;">
    Nie masz konta? <a href="/register">Zarejestruj się</a>
</p>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('loginForm');
  const errorDiv = document.getElementById('error');
  const submitBtn = document.getElementById('submitBtn');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    errorDiv.textContent = '';
    submitBtn.disabled = true;

    const formData = new FormData(form);
    const username = (formData.get('username') || '').toString().trim();
    const password = formData.get('password') || '';
    const csrf = formData.get('csrf_token') || '';

    if (!username || !password) {
      errorDiv.textContent = 'Uzupełnij wszystkie pola';
      submitBtn.disabled = false;
      return;
    }

    const payload = { username, password };

    try {
      const res = await fetch('/login', {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json',
          'X-CSRF-Token': csrf
        },
        credentials: 'same-origin',
        body: JSON.stringify(payload)
      });

      const data = await res.json();

      if (!res.ok) {
        errorDiv.textContent = data.error || data.detail || 'Błąd logowania';
        submitBtn.disabled = false;
        return;
      }

      window.location.href = data.redirect || '/';
    } catch (err) {
      console.error(err);
      errorDiv.textContent = 'Błąd sieciowy — spróbuj ponownie';
      submitBtn.disabled = false;
    }
  });
});
</script>

{% endblock %}
